name: CI/CD - Flask Docker App

# ğŸš€ Quando essa pipeline serÃ¡ executada
on:
  push:
    branches: [ "main" ]  # Quando houver push na branch principal
  pull_request:
    branches: [ "main" ]  # Quando alguÃ©m abrir um PR para a branch principal

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # MÃ¡quina virtual que executa a pipeline

    # ğŸ”Œ ServiÃ§os auxiliares (como o banco de dados MySQL)
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: flaskdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:

      ### 1. â¬‡ï¸ Baixar o cÃ³digo do repositÃ³rio
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      ### 2. ğŸ Preparar o ambiente Python
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      ### 3. ğŸ“¦ Instalar as dependÃªncias do projeto
      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      ### 4. ğŸ•µï¸â€â™‚ï¸ Verificar se o MySQL estÃ¡ pronto
      - name: Esperar o MySQL iniciar
        run: |
          sudo apt-get install -y mysql-client
          echo "Aguardando o MySQL iniciar..."
          for i in {1..10}; do
            if mysqladmin ping -h mysql -uroot -proot --silent; then
              echo "MySQL estÃ¡ pronto!"
              break
            fi
            echo "Esperando MySQL..."
            sleep 5
          done

      ### 5. ğŸ§ª Testar conexÃ£o com o banco
      - name: Testar conexÃ£o com banco MySQL
        run: |
          mysql -h mysql -u root -proot -e "SHOW DATABASES;"

      ### 6. ğŸ§ª (Opcional) Rodar testes automatizados
      # - name: Executar testes
      #   run: |
      #     pytest  # ou outro framework que vocÃª estiver usando

      ### 7. ğŸ³ Validar o Dockerfile (build da imagem)
      - name: Build da imagem Docker
        run: docker build -t flask-app .

      ### 8. (Opcional) Push para DockerHub ou Deploy
      # - name: Push para DockerHub
      #   run: docker push seu-usuario/seu-repositorio
